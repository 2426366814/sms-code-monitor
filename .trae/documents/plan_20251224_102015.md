# 修复API密钥生成失败问题

## 问题分析
从截图可以看到，API密钥生成失败，错误信息是：`SQLSTATE[42S02]: Base table or view not found: 1146 Table 'jm.api_keys' doesn't exist`

检查`database.sql`文件后，发现文件中确实包含`api_keys`表的创建语句（第140-153行），但存在**重复的表创建语句**，这可能导致SQL脚本执行失败，从而使`api_keys`表没有被创建。

## 根本原因
1. `database.sql`文件中存在重复的表创建语句（users、monitors、codes表被创建了两次）
2. 重复的表创建可能导致SQL脚本执行失败，中断后续表的创建
3. `api_keys`表的创建语句位于文件后半部分，可能没有被执行
4. 代码中的表创建逻辑可能存在缺陷，没有确保`api_keys`表一定能成功创建

## 修复方案

### 1. 修复`database.sql`文件
移除重复的表创建语句，确保SQL脚本能成功执行：
- 移除重复的users表创建（第60-70行）
- 移除重复的monitors表创建（第111-127行）
- 移除重复的codes表创建（第129-138行）
- 确保`api_keys`表的创建语句正确

### 2. 改进代码中的表创建逻辑
修改`ApiService.php`中的`ensureApiKeysTableExists`方法：
- 确保表创建语句正确
- 表创建失败时抛出异常，中断后续操作
- 添加详细的错误日志

### 3. 加强初始化检查
在系统初始化时确保所有必要的表都存在：
- 修改`DatabaseInit.php`，确保`api_keys`表被正确创建
- 添加表存在性检查

## 实施步骤

1. 修改`database.sql`文件，移除重复的表创建语句
2. 修改`ApiService.php`中的`ensureApiKeysTableExists`方法，确保表能成功创建
3. 测试API密钥生成功能
4. 运行项目打包脚本

## 预期结果
- `database.sql`文件能成功执行
- `api_keys`表能成功创建
- API密钥生成功能正常工作
- 不再出现"表不存在"错误
- 项目可以正常打包