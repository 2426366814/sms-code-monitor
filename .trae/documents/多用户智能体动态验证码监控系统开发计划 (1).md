# 多用户智能体动态验证码监控系统开发计划

## 1. 项目概述

基于单机版验证码监控系统，开发一个支持多用户的智能体动态验证码监控系统，实现用户认证、角色管理、API功能和管理员面板等核心功能。

## 2. 系统架构设计

### 2.1 技术栈选择

| 分类 | 技术 | 版本 | 用途 |
|------|------|------|------|
| 后端语言 | PHP | 7.4+ | 服务端开发 |
| 数据库 | MySQL | 5.7+ | 数据存储 |
| 认证 | JWT | - | API认证和授权 |
| 前端 | HTML5 + CSS3 + JavaScript | - | 前端界面开发 |
| API设计 | RESTful | - | 前后端通信 |
| 部署 | 宝塔面板 | - | 服务器部署和管理 |

### 2.2 目录结构

```
dynamic-captcha-monitor/
├── api/                    # 后端API代码
│   ├── utils/              # 工具类
│   │   ├── Database.php
│   │   ├── JwtUtils.php
│   │   ├── Response.php
│   │   └── Log.php
│   ├── config.php          # 配置文件
│   ├── auth.php            # 认证API
│   ├── monitors.php        # 监控API
│   ├── codes.php           # 验证码API
│   └── admin.php           # 管理员API
├── public/                 # 前端页面
│   ├── login.html          # 登录页面
│   ├── register.html       # 注册页面
│   ├── dashboard.html      # 仪表盘
│   ├── monitors.html       # 监控管理
│   ├── codes.html          # 验证码历史
│   ├── api-settings.html   # API设置
│   ├── settings.html       # 用户设置
│   └── admin.html          # 管理员页面
├── database.sql            # 数据库脚本
├── 宝塔面板安装文档.md        # 宝塔安装文档
└── 多用户版本开发文档.md        # 多用户版本开发文档
```

## 3. 数据库设计

### 3.1 核心表结构

#### 3.1.1 users表
| 字段名 | 类型 | 约束 | 描述 |
|--------|------|------|------|
| id | INT | PRIMARY KEY AUTO_INCREMENT | 用户ID |
| username | VARCHAR(50) | NOT NULL UNIQUE | 用户名 |
| email | VARCHAR(100) | NOT NULL UNIQUE | 邮箱 |
| password_hash | VARCHAR(255) | NOT NULL | 密码哈希 |
| role | ENUM('admin','user') | NOT NULL DEFAULT 'user' | 用户角色 |
| created_at | TIMESTAMP | NOT NULL DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新时间 |
| last_login_at | TIMESTAMP | NULL | 最后登录时间 |
| status | ENUM('active','inactive') | NOT NULL DEFAULT 'active' | 用户状态 |

#### 3.1.2 monitors表
| 字段名 | 类型 | 约束 | 描述 |
|--------|------|------|------|
| id | INT | PRIMARY KEY AUTO_INCREMENT | 监控ID |
| user_id | INT | NOT NULL FOREIGN KEY | 所属用户ID |
| name | VARCHAR(100) | NOT NULL | 监控名称 |
| url | VARCHAR(255) | NOT NULL | 验证码URL |
| type | VARCHAR(20) | NOT NULL DEFAULT 'image' | 验证码类型 |
| interval | INT | NOT NULL DEFAULT 1000 | 刷新间隔（毫秒） |
| status | ENUM('active','inactive') | NOT NULL DEFAULT 'active' | 监控状态 |
| last_updated | TIMESTAMP | NULL | 最后更新时间 |
| created_at | TIMESTAMP | NOT NULL DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新时间 |

#### 3.1.3 codes表
| 字段名 | 类型 | 约束 | 描述 |
|--------|------|------|------|
| id | INT | PRIMARY KEY AUTO_INCREMENT | 验证码ID |
| monitor_id | INT | NOT NULL FOREIGN KEY | 所属监控ID |
| code | VARCHAR(20) | NOT NULL | 验证码值 |
| original_text | TEXT | NULL | 原始响应文本 |
| extracted_time | TIMESTAMP | NULL | 提取时间 |
| status | ENUM('active','inactive') | NOT NULL DEFAULT 'active' | 验证码状态 |
| created_at | TIMESTAMP | NOT NULL DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新时间 |

#### 3.1.4 api_settings表
| 字段名 | 类型 | 约束 | 描述 |
|--------|------|------|------|
| id | INT | PRIMARY KEY AUTO_INCREMENT | 设置ID |
| user_id | INT | NOT NULL FOREIGN KEY | 所属用户ID |
| api_key | VARCHAR(255) | NOT NULL UNIQUE | API密钥 |
| rate_limit | INT | NOT NULL DEFAULT 60 | 速率限制（次/分钟） |
| status | ENUM('enabled','disabled') | NOT NULL DEFAULT 'enabled' | API状态 |
| allowed_ips | TEXT | NULL | 允许的IP地址（JSON格式） |
| created_at | TIMESTAMP | NOT NULL DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新时间 |

#### 3.1.5 logs表
| 字段名 | 类型 | 约束 | 描述 |
|--------|------|------|------|
| id | INT | PRIMARY KEY AUTO_INCREMENT | 日志ID |
| user_id | INT | NULL FOREIGN KEY | 操作用户ID |
| action | VARCHAR(50) | NOT NULL | 操作类型 |
| details | TEXT | NULL | 操作详情 |
| ip_address | VARCHAR(45) | NOT NULL | IP地址 |
| created_at | TIMESTAMP | NOT NULL DEFAULT CURRENT_TIMESTAMP | 创建时间 |

## 4. 核心功能设计

### 4.1 用户认证系统

#### 4.1.1 注册功能
- 邮箱/用户名注册
- 密码复杂度检查
- 用户状态管理

#### 4.1.2 登录功能
- 邮箱/用户名登录
- JWT令牌生成
- 记住密码选项

#### 4.1.3 密码管理
- 修改密码
- 忘记密码（邮箱验证码重置）

#### 4.1.4 角色管理
- 管理员：系统管理、用户管理
- 普通用户：个人监控管理

### 4.2 用户面板功能

#### 4.2.1 个人信息管理
- 修改用户名
- 修改密码
- 查看账户信息

#### 4.2.2 监控管理
- 添加、编辑、删除监控
- 批量导入监控
- 监控状态管理
- 自动刷新设置

#### 4.2.3 验证码管理
- 查看验证码历史记录
- 搜索和筛选验证码
- 复制验证码
- 导出验证码数据

#### 4.2.4 API设置
- 生成API密钥
- 复制API密钥
- 重置API密钥
- 设置速率限制
- IP白名单设置

### 4.3 管理员面板功能

#### 4.3.1 用户管理
- 查看所有用户
- 添加新用户
- 编辑用户信息
- 修改用户角色
- 禁用/启用用户
- 删除用户

#### 4.3.2 系统管理
- 全局设置
- 查看系统日志
- 统计分析

#### 4.3.3 监控管理
- 查看所有监控项
- 批量操作监控项

## 5. 前端页面设计

### 5.1 登录页面
- 登录表单
- 注册链接
- 忘记密码链接

### 5.2 注册页面
- 注册表单
- 登录链接

### 5.3 仪表盘
- 监控统计卡片
- 最新验证码列表
- 快速操作按钮

### 5.4 监控管理页面
- 监控列表
- 添加/编辑监控模态框
- 批量操作按钮
- 搜索和筛选功能

### 5.5 验证码历史页面
- 验证码列表
- 搜索和筛选功能
- 导出按钮

### 5.6 API设置页面
- API密钥显示
- 生成/重置按钮
- 速率限制设置
- IP白名单设置

### 5.7 用户设置页面
- 个人信息编辑
- 密码修改

### 5.8 管理员页面
- 用户管理列表
- 系统设置表单
- 统计分析图表

## 6. 后端API设计

### 6.1 认证API
- POST /api/auth/register - 用户注册
- POST /api/auth/login - 用户登录
- POST /api/auth/refresh - 刷新令牌
- POST /api/auth/logout - 用户登出
- PUT /api/auth/password - 修改密码
- PUT /api/auth/username - 修改用户名

### 6.2 用户API
- GET /api/user/profile - 获取当前用户信息
- GET /api/user/monitors - 获取用户监控列表
- POST /api/user/monitors - 添加监控
- PUT /api/user/monitors/{id} - 更新监控
- DELETE /api/user/monitors/{id} - 删除监控

### 6.3 监控API
- POST /api/monitors/{id}/refresh - 刷新单个监控
- POST /api/monitors/refresh-all - 刷新所有监控
- POST /api/monitors/batch - 批量添加监控

### 6.4 验证码API
- GET /api/codes - 获取验证码历史
- GET /api/codes/latest - 获取最新验证码
- GET /api/codes/export - 导出验证码数据

### 6.5 API设置API
- GET /api/api-settings - 获取API设置
- PUT /api/api-settings - 更新API设置
- POST /api/api-settings/regenerate - 重新生成API密钥

### 6.6 管理员API
- GET /api/admin/users - 获取所有用户
- POST /api/admin/users - 添加用户
- PUT /api/admin/users/{id} - 更新用户
- DELETE /api/admin/users/{id} - 删除用户
- GET /api/admin/stats - 获取系统统计
- GET /api/admin/logs - 获取系统日志

## 7. 安全设计

### 7.1 身份认证
- JWT令牌认证
- 密码哈希存储
- 令牌过期机制
- 刷新令牌

### 7.2 数据安全
- HTTPS加密传输
- 输入验证和过滤
- SQL注入防护
- XSS攻击防护

### 7.3 API安全
- API密钥认证
- 请求频率限制
- IP访问控制
- 错误信息隐藏

## 8. 部署方案

### 8.1 宝塔面板部署
- 环境配置（PHP 7.4+, MySQL 5.7+）
- 网站创建和配置
- SSL证书配置
- 数据库创建和导入
- 代码部署

### 8.2 安装步骤
1. 登录宝塔面板
2. 创建网站和数据库
3. 上传代码文件
4. 导入数据库脚本
5. 配置网站参数
6. 测试访问

## 9. 开发步骤

### 9.1 阶段一：基础架构搭建
1. 搭建PHP开发环境
2. 创建数据库和表结构
3. 配置文件编写
4. 核心工具类开发（Database, JWT, Response, Log）

### 9.2 阶段二：认证系统开发
1. 用户注册功能
2. 用户登录功能
3. JWT令牌生成和验证
4. 密码修改功能

### 9.3 阶段三：监控系统开发
1. 监控项CRUD功能
2. 自动刷新机制
3. 验证码提取算法
4. 历史记录管理

### 9.4 阶段四：API功能开发
1. API密钥管理
2. 公共API端点开发
3. API访问控制

### 9.5 阶段五：管理员功能开发
1. 用户管理功能
2. 系统设置功能
3. 统计分析功能

### 9.6 阶段六：前端页面开发
1. 登录、注册页面
2. 仪表盘页面
3. 监控管理页面
4. 验证码历史页面
5. API设置页面
6. 用户设置页面
7. 管理员页面

### 9.7 阶段七：测试和部署
1. 功能测试
2. 性能测试
3. 安全测试
4. 宝塔面板部署
5. 上线测试

## 10. 文档编写

1. 系统需求文档
2. 数据库设计文档
3. API接口文档
4. 部署安装文档
5. 用户使用手册
6. 管理员操作手册

## 11. 预期成果

1. 完整的多用户智能体动态验证码监控系统
2. 支持用户认证和角色管理
3. 提供API功能
4. 包含管理员和用户面板
5. 详细的部署和使用文档
6. 支持宝塔面板一键部署

## 12. 核心功能实现

### 12.1 后端API实现

#### 12.1.1 工具类开发
- Database.php：单例数据库连接类
- JwtUtils.php：JWT令牌生成和验证
- Response.php：标准化JSON响应
- Log.php：日志记录

#### 12.1.2 认证API实现
- register：用户注册
- login：用户登录
- refresh：刷新令牌
- logout：用户登出
- update-password：修改密码
- update-username：修改用户名

#### 12.1.3 监控API实现
- get-monitors：获取监控列表
- add-monitor：添加监控
- update-monitor：更新监控
- delete-monitor：删除监控
- refresh-monitor：刷新监控
- refresh-all-monitors：刷新所有监控
- batch-import：批量导入监控

#### 12.1.4 验证码API实现
- get-codes：获取验证码历史
- get-latest-code：获取最新验证码
- export-codes：导出验证码

#### 12.1.5 管理员API实现
- get-users：获取用户列表
- add-user：添加用户
- update-user：更新用户
- delete-user：删除用户
- get-stats：获取统计信息

### 12.2 前端页面实现

#### 12.2.1 登录页面
- 登录表单
- 表单验证
- JWT令牌存储

#### 12.2.2 注册页面
- 注册表单
- 表单验证
- 密码复杂度检查

#### 12.2.3 仪表盘
- 数据统计展示
- 最新验证码列表
- 快速操作按钮

#### 12.2.4 监控管理页面
- 监控列表展示
- 添加/编辑监控功能
- 批量操作功能

#### 12.2.5 验证码历史页面
- 验证码列表展示
- 搜索和筛选功能
- 复制验证码功能

#### 12.2.6 API设置页面
- API密钥管理
- 速率限制设置
- IP白名单设置

#### 12.2.7 用户设置页面
- 个人信息编辑
- 密码修改

#### 12.2.8 管理员页面
- 用户管理功能
- 系统设置功能

## 13. 测试计划

### 13.1 功能测试
- 认证功能测试
- 监控管理功能测试
- 验证码功能测试
- API功能测试
- 管理员功能测试

### 13.2 性能测试
- 系统响应时间测试
- 并发处理能力测试
- 数据库性能测试

### 13.3 安全测试
- 身份认证测试
- 数据安全测试
- API安全测试

## 14. 部署计划

### 14.1 环境配置
- PHP 7.4+安装
- MySQL 5.7+安装
- Nginx/Apache配置
- SSL证书配置

### 14.2 数据库部署
- 创建数据库
- 导入数据库脚本
- 配置数据库连接

### 14.3 代码部署
- 上传代码文件
- 配置权限
- 测试访问

## 15. 维护计划

### 15.1 系统维护
- 定期备份数据库
- 定期更新系统和依赖
- 监控系统运行状态

### 15.2 安全维护
- 定期安全审计
- 及时修复安全漏洞
- 更新安全策略

## 16. 风险评估

| 风险 | 影响 | 应对措施 |
|------|------|----------|
| 验证码提取失败 | 无法获取有效验证码 | 优化提取算法，支持多种验证码格式 |
| API请求频率过高 | 系统性能下降 | 实现速率限制，优化数据库查询 |
| 安全性问题 | 数据泄露 | 严格的安全设计，定期安全审计 |
| 部署问题 | 系统无法正常运行 | 详细的部署文档，提供技术支持 |

## 17. 总结

本计划详细描述了多用户智能体动态验证码监控系统的开发方案，包括系统架构设计、数据库设计、核心功能实现等方面。通过本计划的实施，将开发出一个功能完整、安全可靠、易于使用的多用户验证码监控系统。